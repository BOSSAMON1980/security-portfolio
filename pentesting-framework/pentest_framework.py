#!/usr/bin/env python3
"""
Automated Penetration Testing Framework
Author: Sean Amon | OSCP Candidate
A modular framework for automated penetration testing and vulnerability management
"""

import argparse
import json
import yaml
import sys
from datetime import datetime
from pathlib import Path
import concurrent.futures

class PentestFramework:
    def __init__(self, target, output_dir='reports'):
        self.target = target
        self.output_dir = Path(output_dir)
        self.output_dir.mkdir(exist_ok=True)
        
        self.modules = []
        self.findings = []
        self.scan_results = {}
        
    def register_module(self, module):
        """Register a testing module"""
        self.modules.append(module)
        
    def run_reconnaissance(self):
        """Run reconnaissance phase"""
        print("[*] Starting reconnaissance phase...")
        
        recon_modules = [
            self.passive_recon,
            self.active_recon,
            self.subdomain_enumeration,
            self.port_scanning,
            self.web_enumeration
        ]
        
        with concurrent.futures.ThreadPoolExecutor(max_workers=3) as executor:
            futures = [executor.submit(module) for module in recon_modules]
            for future in concurrent.futures.as_completed(futures):
                try:
                    result = future.result()
                    self.scan_results.update(result)
                except Exception as e:
                    print(f"[!] Recon module failed: {e}")
                    
        return self.scan_results
        
    def run_vulnerability_assessment(self):
        """Run vulnerability assessment phase"""
        print("[*] Starting vulnerability assessment...")
        
        # Implementation of various vulnerability tests
        pass
        
    def run_exploitation(self):
        """Run exploitation phase (authorized testing only)"""
        print("[*] Starting exploitation phase...")
        
        # Implementation would go here
        # Only runs if explicitly enabled and authorized
        
        return []
        
    def generate_report(self):
        """Generate professional pentest report"""
        report = {
            'metadata': {
                'report_id': f"pentest_{datetime.now().strftime('%Y%m%d_%H%M%S')}",
                'target': self.target,
                'date': datetime.now().isoformat(),
                'analyst': 'Sean Amon',
                'methodology': 'PTES (Penetration Testing Execution Standard)'
            },
            'phases': {
                'reconnaissance': self.scan_results,
                'vulnerability_assessment': {},
                'exploitation': {},
                'post_exploitation': {},
                'reporting': {}
            },
            'findings': self.findings,
            'risk_assessment': self.assess_risk(),
            'recommendations': self.generate_recommendations(),
            'appendix': {
                'tools_used': ['Custom Python Framework', 'Nmap', 'GoBuster'],
                'testing_time': 'Varies by scope',
                'references': [
                    'PTES: http://www.pentest-standard.org/',
                    'OWASP: https://owasp.org/',
                    'NIST: https://csrc.nist.gov/'
                ]
            }
        }
        
        # Save reports in multiple formats
        json_file = self.output_dir / f"report_{report['metadata']['report_id']}.json"
        with open(json_file, 'w') as f:
            json.dump(report, f, indent=2, default=str)
            
        html_file = self.output_dir / f"report_{report['metadata']['report_id']}.html"
        self.generate_html_report(report, html_file)
        
        print(f"[*] Reports saved to: {json_file}, {html_file}")
        return report
        
    def assess_risk(self):
        """Assess overall risk based on findings"""
        # Implementation would calculate risk scores
        return {
            'overall_risk': 'Medium',
            'factors': ['Exposed services', 'Weak configurations'],
            'score': 65
        }
        
    def generate_recommendations(self):
        """Generate actionable recommendations"""
        return {
            'immediate': [
                'Patch critical vulnerabilities within 24 hours',
                'Implement network segmentation',
                'Review and update firewall rules'
            ],
            'short_term': [
                'Conduct security awareness training',
                'Implement monitoring and alerting',
                'Regular vulnerability scanning'
            ],
            'long_term': [
                'Establish security governance framework',
                'Implement DevSecOps practices',
                'Regular penetration testing schedule'
            ]
        }
        
    def passive_recon(self):
        """Perform passive reconnaissance"""
        print("  [*] Performing passive reconnaissance...")
        # Implementation would use various OSINT tools
        return {'passive_recon': {'status': 'completed'}}
        
    def active_recon(self):
        """Perform active reconnaissance"""
        print("  [*] Performing active reconnaissance...")
        return {'active_recon': {'status': 'completed'}}
        
    # Additional methods would be implemented here...
    
    def generate_html_report(self, report, output_file):
        """Generate HTML pentest report"""
        html_template = """
        <!DOCTYPE html>
        <html>
        <head>
            <title>Penetration Test Report - {target}</title>
            <style>
                body {{ font-family: Arial, sans-serif; margin: 40px; }}
                .header {{ background: #2c3e50; color: white; padding: 30px; border-radius: 10px; }}
                .finding {{ border: 1px solid #ddd; margin: 15px 0; padding: 20px; border-radius: 8px; }}
                .critical {{ border-left: 5px solid #e74c3c; }}
                .high {{ border-left: 5px solid #e67e22; }}
                .medium {{ border-left: 5px solid #f1c40f; }}
                .low {{ border-left: 5px solid #3498db; }}
            </style>
        </head>
        <body>
            <div class="header">
                <h1>ğŸ” Penetration Test Report</h1>
                <p><strong>Target:</strong> {target}</p>
                <p><strong>Date:</strong> {date}</p>
                <p><strong>Analyst:</strong> {analyst}</p>
            </div>
            
            <h2>ğŸ“Š Executive Summary</h2>
            <p>Overall Risk: <strong>{risk}</strong> (Score: {score}/100)</p>
            
            <h2>ğŸ“‹ Findings</h2>
            {findings_html}
            
            <h2>ğŸ¯ Recommendations</h2>
            {recommendations_html}
            
            <div style="margin-top: 40px; text-align: center; color: #7f8c8d;">
                <p>Report generated by Sean Amon Pentesting Framework</p>
                <p>Confidential - Authorized personnel only</p>
            </div>
        </body>
        </html>
        """
        
        # Generate findings HTML
        findings_html = ""
        if report['findings']:
            for finding in report['findings']:
                findings_html += f"""
                <div class="finding {finding.get('severity', 'medium').lower()}">
                    <h3>{finding.get('title', 'Finding')}</h3>
                    <p><strong>Severity:</strong> {finding.get('severity', 'N/A')}</p>
                    <p><strong>Description:</strong> {finding.get('description', 'N/A')}</p>
                    <p><strong>Remediation:</strong> {finding.get('remediation', 'N/A')}</p>
                </div>
                """
        else:
            findings_html = "<p>No findings documented in this report.</p>"
            
        # Generate recommendations HTML
        recs = report['recommendations']
        recommendations_html = f"""
        <h3>Immediate (24-48 hours)</h3>
        <ul>
            {''.join(f'<li>{rec}</li>' for rec in recs['immediate'])}
        </ul>
        
        <h3>Short Term (1 week)</h3>
        <ul>
            {''.join(f'<li>{rec}</li>' for rec in recs['short_term'])}
        </ul>
        
        <h3>Long Term</h3>
        <ul>
            {''.join(f'<li>{rec}</li>' for rec in recs['long_term'])}
        </ul>
        """
        
        html_content = html_template.format(
            target=report['metadata']['target'],
            date=report['metadata']['date'],
            analyst=report['metadata']['analyst'],
            risk=report['risk_assessment']['overall_risk'],
            score=report['risk_assessment']['score'],
            findings_html=findings_html,
            recommendations_html=recommendations_html
        )
        
        with open(output_file, 'w') as f:
            f.write(html_content)
            
def main():
    parser = argparse.ArgumentParser(description='Automated Penetration Testing Framework')
    parser.add_argument('target', help='Target to test (domain, IP, or range)')
    parser.add_argument('-o', '--output', default='reports', help='Output directory')
    parser.add_argument('-p', '--phases', nargs='+', 
                       choices=['recon', 'vuln', 'exploit', 'post', 'all'],
                       default=['recon', 'vuln'],
                       help='Testing phases to execute')
    
    args = parser.parse_args()
    
    print("""
    â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
    â•‘      AUTOMATED PENETRATION TESTING FRAMEWORK            â•‘
    â•‘                 Sean Amon | OSCP Candidate              â•‘
    â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    """)
    
    framework = PentestFramework(args.target, args.output)
    
    if 'recon' in args.phases or 'all' in args.phases:
        framework.run_reconnaissance()
        
    if 'vuln' in args.phases or 'all' in args.phases:
        framework.run_vulnerability_assessment()
        
    # Exploitation phase requires explicit authorization
    if 'exploit' in args.phases:
        confirm = input("[!] Exploitation phase requires authorization. Continue? (y/N): ")
        if confirm.lower() == 'y':
            framework.run_exploitation()
            
    report = framework.generate_report()
    print("\n[*] Penetration testing completed!")
    print(f"[*] Report generated for {args.target}")
    
if __name__ == "__main__":
    main()
